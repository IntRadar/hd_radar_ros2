Hd Radar Driver
================
Введение
---
Это ROS 2 драйвер для радара высокого разрешения созданного компанией Integrant.


Структура драйвера:
---
Этот проект содержит два ROS2 пакета: hd_radar_driver и hd_radar_interfaces. Ниже приведены описание и структура каждого из данных пакетов.

* ### hd_radar_driver.
    Этот пакет содержит весь основной код и скрипты для взаимодействия пользователя с радаром. Пакет позволяет принимать данные, визуализировать их, декодировать, а также отправлять различную служебную информацию на радар.
    * ### hd_radar_driver.hpp
        Этот файл описывает класс, который используется для установления соединения с радаром, получения всех отправляемых им данных, их фильтрации и дальнейшей публикации в инфраструктуре ROS2. Также данный класс отвечает за обмен служебной информацией с радаром через сервисы ROS2.

        Во время инициализации класса создаются издатели и сервисы ROS2 для различных типов сообщений.
        
        Затем в отдельном потоке устанавливается соединение с радаром и запускается бесконечный цикл в котором осуществляется приём сообщений. Каждое сообщение в зависимости от его типа фильтруется и запускается алгоритм его обработки после чего оно публикуется.
    * ### hd_radar_node.cpp
        Этот файл содержит main функцию, которая запускает экземпляр класса драйвера hd радара.
    * ### hd_radar_structs.hpp
        Этот файл содержит основные структуры сообщений и другие вспомогательные структуры используемые драйвером. 
    * ### hd_radar_heat.hpp
        Этот файл описывает класс, который используется для обработки сообщений с картой дальность-скорость и подготовки их к дальнейшей публикации в ROS2 формате.
    * ### hd_radar_pcl.hpp
        Этот файл описывает класс, который используется для обработки сообщений с облаком точек и подготовки их к дальнейшей публикации в ROS2 формате.
    * ### hd_radar_raw.hpp
        Этот файл описывает класс, который используется для обработки сообщений с "сырыми" данными и подготовки их к дальнейшей публикации в ROS2 формате.
    * ### crc16_ccitt.hpp
        Этот файл содержит функции для рассчёта контрольных сумм crc16 используемых драйвером радара.
    * ### hd_radar_service_caller.perspective
        Этот файл содержит конфигурацию rqt для отправления сервисных сообщений.
    * ### hd_radar_single.rviz
        Этот файл содержит конфигурацию rviz 2 для отображения облака точек и карты дальность-скорость для одного радара.
    * ### hd_radar.launch.py
        Этот файл предназначен для запуска драйвера радара посредством выполнения следующей команды:
        ```
        ros2 launch hd_radar_driver hd_radar.launch.py
        ```
        При запуске данного файла создаются следующие узлы:
        - Узел визуализации, который запускает rviz 2 для отображения облака точек и карты дальность-скорость.
        - Узел работы со служебными командами радара, который запускает rqt в режиме работы с сервисами ros 2.
        - Основной узел для работы с радаром, который может запустить несколько экземпляров в зависимости от количества устройств и настроек указанных в конфигурационном файле.
    * ### hd_radar_config.yaml
        Это конфигурационный файл, который используется для запуска радара и включают в себя следующие параметры: 
        - Порядковый номер радара, который должен быть запущен.
        - IP адрес радара.
        - Мультикаст IP адрес радара.
        - Порт по которому будут приниматься данные.
        - Проверка контрольной суммы в пакетах сообщений от радара.
    * ### CMakeLists.txt и package.xml
        Эти файлы определяют все зависимости и настройки необходимые для сборки пакета.
* ### hd_radar_interfaces.
    Этот пакет содержит основные и сервисные сообщения с которыми может взаимодействовать пользователь в инфраструктуре ROS2.
    * ### Heat.msg
        Этот файл содержит структуру сообщения карты дальность-скорость.

    * ### Raw.msg
        Этот файл содержит структуру сообщения с "сырыми" данными.

    * ### GetRaw.srv
        Этот файл содержит структуру сообщения для запроса "сырых" данных.

    * ### SetMode.srv
        Этот файл содержит структуру сообщения для установки режима работы радара.

    * ### SetThr.srv
        Этот файл содержит структуру сообщения для установки параметров чувствительности работы радара.

    * ### SetVel.srv
        Этот файл содержит структуру сообщения для установки параметров скорости для работы радара.

    * ### CMakeLists.txt и package.xml
        Эти файлы определяют все зависимости и настройки необходимые для сборки пакета.

Подготовка к запуску
---
Для правильной сборки и запуска драйвера hd радара необходимо выполнить следующие условия:
- Установить Ubuntu 22.04.
- Установить ROS 2.
- Настроить сеть для подключения к радару.

* ### Установка Ubuntu 22.04.
    Образ с Ubuntu 22.04 можно скачать по следующей ссылке:
    [https://releases.ubuntu.com/jammy/](https://releases.ubuntu.com/jammy/).
    Образ может быть установлен как на локальную, так и на виртуальную машины.
* ### Установка ROS 2.
    Для установки ROS 2 можно воспользоваться следующим руководством: [https://docs.ros.org/en/humble/Installation.html](https://docs.ros.org/en/humble/Installation.html).

Сборка и запуск драйвера
---
Для сборки и запуска драйвера необходимо перейти в каталог, который был создан, как рабочее пространство ROS2, и скопировать в папку src данный набор ROS2 пакетов. 
Перед сборкой и запуском драйвера необходимо сверить параметры в конфигурационном файле hd_radar_config.yaml с параметрами подключённого радара.\
Изменить сетевые параметры радара, можно во вкладке "Configuration" на странице веб-интерфейса http://192.168.1.50 (IP-адрес радара по умолчанию).\
Ip адрес ethernet-интерфейса в системе Ubuntu 22.04 можно поменять через графическую оболочку системы в соответствующем меню, либо с помощью команды в консоли:
```
sudo ip addr add 192.168.1.100/24 dev <имя сетевого интерфейса>
```
Узнать имя сетевого интерфейса можно командой:
```
sudo ip a
```
А очистить список установленных ip адресов можно с помощью команды:
```
 sudo ip addr flush dev <имя сетевого интерфейса>
```
Перезагрузить сетевой интерфейс можно с помощью команд:
```
sudo ip link set <имя сетевого интерфейса> down

sudo ip link set <имя сетевого интерфейса> up
```
После этого необходимо снова переместиться в верхний каталог рабочего пространства ROS2 и выполнить следующие команды:
```
colcon build --packages-select hd_radar_interfaces
colcon build --packages-select hd_radar_driver
source install/setup.bash
ros2 launch hd_radar_driver hd_radar.launch.py
```

Запуск драйвера с помощью Docker
---
Если необходимо запустить драйвер на системе, где не установлен ROS2 Humble, то можно воспользоваться данным методом.

Сначала необходимо установить Docker, для этого можно воспользоваться следующим руководством:[https://docs.docker.com/engine/install/](https://docs.docker.com/engine/install/).

После этого нужно собрать docker образ. Для этого необходимо запустить скрипт _build.sh_ из папки docker, выполнив в данной папке следующую команду:
```
./buld.sh
```
Также можно запустить драйвер из уже собранного docker-образа, для этого необходимо выполнить команду:
```
docker load -i <имя архива с docker образом>.tar
```
После этого для запуска драйвера с визуализацией Rviz 2 следует выполнить следующую команду:
```
./run_radar_rviz.sh
```
Для запуска драйвера без визуализацией Rviz 2 следует выполнить следующую команду:
```
./run_radar.sh
```
Для остановки docker-контейнера следует выполнить следующую команду:
```
docker stop hd_radar
```
Для очистки кэша сборщика docker-образов следует выполнить следующую команду:
```
docker builder prune
```
